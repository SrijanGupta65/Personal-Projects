<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HuskySpend - Student Finance Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fb;
            color: #2c3e50;
            line-height: 1.6;
        }

        .navbar {
            background: white;
            border-bottom: 1px solid #e1e8ed;
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .navbar-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 1.5em;
            font-weight: 700;
            color: #2c3e50;
        }

        .logo span {
            color: #667eea;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }

        h2 {
            font-size: 1.5em;
            margin-bottom: 24px;
            color: #2c3e50;
            font-weight: 600;
        }

        .upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .upload-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 48px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            background: #f8f9ff;
        }

        .upload-box:hover {
            background: #f0f4ff;
            border-color: #764ba2;
            transform: translateY(-2px);
        }

        .upload-box input {
            display: none;
        }

        .upload-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
        }

        .upload-text {
            color: #2c3e50;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .upload-subtext {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        input[type="number"] {
            padding: 12px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        small {
            color: #7f8c8d;
            font-size: 0.85em;
            margin-top: 4px;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 40px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .metric {
            background: #f8f9fb;
            padding: 20px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .metric-label {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: 700;
            color: #2c3e50;
        }

        .metric.danger {
            border-left-color: #e74c3c;
            background: #fff5f3;
        }

        .metric.danger .metric-value {
            color: #c0392b;
        }

        .metric.success {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .metric.success .metric-value {
            color: #27ae60;
        }

        .metric.warning {
            border-left-color: #f39c12;
            background: #fffaf0;
        }

        .section-header {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin: 32px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid #e1e8ed;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .data-box {
            background: #f8f9fb;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .data-box h4 {
            font-size: 0.95em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e1e8ed;
            font-size: 0.9em;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-label {
            color: #7f8c8d;
            font-weight: 500;
        }

        .data-value {
            color: #2c3e50;
            font-weight: 600;
        }

        .merchant-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
        }

        .merchant-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
            margin-bottom: 4px;
        }

        .merchant-stats {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .ai-insights {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            overflow: hidden;
        }

        .insight-status {
            padding: 20px;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-status.urgent {
            background: #e74c3c;
        }

        .insight-status.at-risk {
            background: #f39c12;
        }

        .insight-status.on-track {
            background: #27ae60;
        }

        .insight-section {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
        }

        .insight-section:last-child {
            border-bottom: none;
        }

        .insight-issue {
            background: #fff9e6;
        }

        .insight-issue h4 {
            color: #c0392b;
            margin-bottom: 8px;
            font-size: 0.95em;
            font-weight: 600;
        }

        .insight-issue p {
            color: #2c3e50;
            margin: 0;
            font-weight: 500;
        }

        .insight-fixes {
            background: #f8f9fb;
        }

        .insight-fixes h4 {
            color: #27ae60;
            margin-bottom: 12px;
            font-size: 0.95em;
            font-weight: 600;
        }

        .fix-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #27ae60;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .fix-item:last-child {
            margin-bottom: 0;
        }

        .insight-budget {
            background: #f0fff4;
            border-left: 3px solid #27ae60;
        }

        .insight-budget h4 {
            color: #27ae60;
            margin-bottom: 8px;
            font-size: 0.95em;
            font-weight: 600;
        }

        .insight-budget p {
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: 700;
            margin: 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #e1e8ed;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fff5f3;
            color: #c0392b;
            padding: 16px;
            border-radius: 6px;
            margin-top: 16px;
            border-left: 3px solid #c0392b;
            font-size: 0.95em;
        }

        .filename {
            color: #667eea;
            font-weight: 600;
            margin-top: 8px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 24px 16px;
            }

            .card {
                padding: 20px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .input-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .upload-box {
                padding: 32px 20px;
            }

            .button {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-content">
            <div class="logo">Husky<span>Spend</span></div>
            <div style="color: #7f8c8d; font-size: 0.9em;">Student Finance Platform</div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Upload Your Husky Card Statement</h2>

            <div class="upload-section">
                <div class="upload-box" id="uploadBox">
                    <div class="upload-icon">ðŸ“Š</div>
                    <div class="upload-text">Click to upload CSV</div>
                    <div class="upload-subtext">or drag and drop your statement</div>
                    <input type="file" id="csvFile" accept=".csv" />
                    <div class="filename" id="filename"></div>
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <label for="balance">Current Balance (Optional)</label>
                        <input type="number" id="balance" placeholder="Auto-detect from statement" step="0.01" />
                        <small>Leave blank to use last transaction balance</small>
                    </div>

                    <div class="input-group">
                        <label for="weeks">Weeks Until End of Quarter</label>
                        <input type="number" id="weeks" value="10" min="1" />
                    </div>
                </div>

                <button class="button" onclick="analyzeSpending()">Analyze Spending</button>
                <div id="message"></div>
            </div>
        </div>

        <div class="card results" id="results">
            <h2>Financial Analysis</h2>

            <div class="metrics-grid">
                <div class="metric" id="balanceMetric">
                    <div class="metric-label">Current Balance</div>
                    <div class="metric-value" id="balanceDisplay">$0.00</div>
                </div>

                <div class="metric" id="runoutMetric">
                    <div class="metric-label">Days Until Depletion</div>
                    <div class="metric-value" id="runoutDisplay">0 days</div>
                </div>

                <div class="metric" id="weeklyMetric">
                    <div class="metric-label">Weekly Spending Average</div>
                    <div class="metric-value" id="weeklyDisplay">$0.00</div>
                </div>

                <div class="metric success">
                    <div class="metric-label">Recommended Weekly Budget</div>
                    <div class="metric-value" id="recommendedDisplay">$0.00</div>
                </div>
            </div>

            <div class="section-header">Spending Breakdown</div>

            <div class="data-grid">
                <div class="data-box">
                    <h4>By Category</h4>
                    <div id="categories"></div>
                </div>

                <div class="data-box">
                    <h4>Top Merchants</h4>
                    <div id="merchants"></div>
                </div>

                <div class="data-box">
                    <h4>By Time of Day</h4>
                    <div id="timeOfDay"></div>
                </div>

                <div class="data-box">
                    <h4>Weekly Trend</h4>
                    <div id="weeklyTrend"></div>
                </div>
            </div>

            <div class="section-header">Advisor Recommendations</div>
            <div class="ai-insights" id="aiInsights">Generating analysis...</div>
        </div>
    </div>

    <script>
        // File upload handling
        document.getElementById('uploadBox').addEventListener('click', () => {
            document.getElementById('csvFile').click();
        });

        document.getElementById('csvFile').addEventListener('change', (e) => {
            const filename = e.target.files[0]?.name || '';
            document.getElementById('filename').textContent = filename ? `Selected: ${filename}` : '';
        });

        // Drag and drop
        const uploadBox = document.getElementById('uploadBox');
        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.style.background = '#f0f4ff';
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.style.background = '';
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.style.background = '';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('csvFile').files = files;
                document.getElementById('filename').textContent = `Selected: ${files[0].name}`;
            }
        });

        async function analyzeSpending() {
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = '';

            const balanceInput = document.getElementById('balance').value;
            const weeks = parseInt(document.getElementById('weeks').value) || 10;
            const file = document.getElementById('csvFile').files[0];

            if (!file) {
                messageEl.innerHTML = '<div class="error">Please select a CSV file to analyze</div>';
                return;
            }

            messageEl.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing your spending...</div>';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to parse file');
                }

                const data = await response.json();
                const currentBalance = balanceInput ? parseFloat(balanceInput) : data.analysis.currentBalance;
                displayResults(data.analysis, currentBalance, weeks);
                messageEl.innerHTML = '';

                // Get AI insights
                try {
                    const analysis = data.analysis;
                    const insightResponse = await fetch('/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            analysis,
                            currentBalance,
                            weeksRemaining: weeks
                        })
                    });

                    if (insightResponse.ok) {
                        const insightData = await insightResponse.json();
                        displayAIInsights(insightData.insights);
                    } else {
                        const errorData = await insightResponse.json();
                        document.getElementById('aiInsights').innerHTML = `<div style="padding: 20px; color: #c0392b;">Unable to generate recommendations: ${errorData.error}</div>`;
                    }
                } catch (err) {
                    console.error('AI error:', err);
                    document.getElementById('aiInsights').innerHTML = `<div style="padding: 20px; color: #c0392b;">Unable to generate recommendations</div>`;
                }
            } catch (error) {
                messageEl.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        function displayResults(analysis, balance, weeks) {
            document.getElementById('balanceDisplay').textContent = `$${balance.toFixed(2)}`;

            const weeklyAvg = analysis.weeklyAverage || 0;
            document.getElementById('weeklyDisplay').textContent = `$${weeklyAvg.toFixed(2)}`;

            const daysUntilRunout = balance > 0 ? Math.ceil((balance / weeklyAvg) * 7) : 0;
            document.getElementById('runoutDisplay').textContent = `${daysUntilRunout} days`;

            const runoutMetric = document.getElementById('runoutMetric');
            runoutMetric.classList.remove('danger', 'warning', 'success');
            if (daysUntilRunout <= 7) {
                runoutMetric.classList.add('danger');
            } else if (daysUntilRunout <= 21) {
                runoutMetric.classList.add('warning');
            } else {
                runoutMetric.classList.add('success');
            }

            const recommended = balance / weeks;
            document.getElementById('recommendedDisplay').textContent = `$${recommended.toFixed(2)}`;

            // Categories
            const categoriesEl = document.getElementById('categories');
            categoriesEl.innerHTML = '';
            Object.entries(analysis.categoryBreakdown || {})
                .sort((a, b) => b[1] - a[1])
                .forEach(([category, amount]) => {
                    categoriesEl.innerHTML += `
                        <div class="data-item">
                            <span class="data-label">${category}</span>
                            <span class="data-value">$${amount.toFixed(2)}</span>
                        </div>
                    `;
                });

            // Merchants
            const merchantsEl = document.getElementById('merchants');
            merchantsEl.innerHTML = '';
            (analysis.merchantBreakdown || []).forEach(m => {
                merchantsEl.innerHTML += `
                    <div class="merchant-item">
                        <div class="merchant-name">${m.name}</div>
                        <div class="merchant-stats">${m.count}x visits Â· $${m.total.toFixed(2)}</div>
                    </div>
                `;
            });

            // Time of day
            const timeEl = document.getElementById('timeOfDay');
            timeEl.innerHTML = '';
            ['Morning', 'Afternoon', 'Evening', 'Night'].forEach(time => {
                const amount = analysis.timeOfDayBreakdown?.[time] || 0;
                if (amount > 0) {
                    timeEl.innerHTML += `
                        <div class="data-item">
                            <span class="data-label">${time}</span>
                            <span class="data-value">$${amount.toFixed(2)}</span>
                        </div>
                    `;
                }
            });

            // Weekly trend
            const trendEl = document.getElementById('weeklyTrend');
            trendEl.innerHTML = '';
            (analysis.weeklyTrend || []).forEach(w => {
                trendEl.innerHTML += `
                    <div class="data-item">
                        <span class="data-label">${w.week}</span>
                        <span class="data-value">$${w.amount.toFixed(2)}</span>
                    </div>
                `;
            });

            document.getElementById('results').classList.add('active');
        }

        function displayAIInsights(insightText) {
            const lines = insightText.split('\n').map(l => l.trim()).filter(l => l);

            let status = 'On Track';
            let statusClass = 'on-track';
            let issue = '';
            let fixes = [];
            let budget = '';

            lines.forEach(line => {
                if (line.includes('STATUS:')) {
                    const statusText = line.replace(/.*STATUS:\s*/i, '').replace(/[^A-Z\s]/g, '').trim();
                    status = statusText || 'On Track';
                    statusClass = status.includes('URGENT') ? 'urgent' :
                                 status.includes('RISK') ? 'at-risk' : 'on-track';
                } else if (line.includes('TOP ISSUE:')) {
                    issue = line.replace(/.*TOP ISSUE:\s*/i, '');
                } else if (line.includes('â€¢') && !line.includes('QUICK FIXES')) {
                    fixes.push(line.replace(/^[â€¢\-\*]\s*/, ''));
                } else if (line.includes('REVISED BUDGET:')) {
                    budget = line.replace(/.*REVISED BUDGET:\s*/i, '');
                }
            });

            let html = `<div class="insight-status ${statusClass}">Status: ${status}</div>`;

            if (issue) {
                html += `<div class="insight-section insight-issue">
                    <h4>Primary Concern</h4>
                    <p>${issue}</p>
                </div>`;
            }

            if (fixes.length > 0) {
                html += `<div class="insight-section insight-fixes">
                    <h4>Recommended Actions</h4>`;
                fixes.slice(0, 3).forEach(fix => {
                    html += `<div class="fix-item">${fix}</div>`;
                });
                html += `</div>`;
            }

            if (budget) {
                html += `<div class="insight-section insight-budget">
                    <h4>Recommended Budget</h4>
                    <p>${budget}</p>
                </div>`;
            }

            document.getElementById('aiInsights').innerHTML = html;
        }
    </script>
</body>
</html>
